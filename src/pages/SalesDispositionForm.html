<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="../images/icons/favicon.ico" />

    <link rel="stylesheet" href="../css/style.css" />
    <title>Disposition Form</title>
    <script>
      // Check the login status from localStorage
      const loginStatus = sessionStorage.getItem("login");
      if (loginStatus !== "Success") {
        // Redirect to index.html if login is not successful
        window.location.href = "../../index.html";
      }
    </script>
  </head>

  <body>
    <div class="container">
      <header>AIMS Sales Disposition Form</header>
      <form
        action=""
        name="submit-to-google-sheet"
        autocomplete="off"
        method="POST"
        id="form"
      >
        <div class="form first">
          <div class="details personal">
            <span class="title">Customer Details</span>
            <div class="fields">
              <div class="input-field">
                <label>Mobile Number</label>
                <input
                  type="number"
                  placeholder="Enter Mobile Number"
                  name="Mobile Number"
                  id="mobile-number"
                  maxlength="10"
                  oninput="checkMobileNumber()"
                  required
                />
              </div>

              <div class="input-field">
                <label>Customer Name</label>
                <input
                  type="text"
                  placeholder="Enter Customer Name"
                  name="Customer Name"
                  id="customer-name"
                  required
                />
              </div>

              <div class="input-field">
                <label>Location</label>
                <select name="Location" id="location" required title="Location">
                  <option disabled selected>Select Location</option>
                  <option value="Panruti (M)">Panruti (M)</option>
                  <option value="Cuddalore">Cuddalore</option>
                  <option value="Villupuram">Villupuram</option>
                  <option value="Neyveli">Neyveli</option>
                  <option value="Nellikuppam">Nellikuppam</option>
                  <option value="Akkadavalli">Akkadavalli</option>
                  <option value="Alagappasamudram">Alagappasamudram</option>
                  <option value="Alagapperumalkuppam">
                    Alagapperumalkuppam
                  </option>
                  <option value="Anguchettipalayam">Anguchettipalayam</option>
                  <option value="Ariyirundamangalam">Ariyirundamangalam</option>
                  <option value="Aviyanur">Aviyanur</option>
                  <option value="Chittarasur">Chittarasur</option>
                  <option value="Eidanur">Eidanur</option>
                  <option value="Elandampattu">Elandampattu</option>
                  <option value="Enadirimangalam">Enadirimangalam</option>
                  <option value="Ezhumedu">Ezhumedu</option>
                  <option value="Kadampuliyur">Kadampuliyur</option>
                  <option value="Kandarakkottai (North)">
                    Kandarakkottai (North)
                  </option>
                  <option value="Kanisapakkam">Kanisapakkam</option>
                  <option value="Karukkai">Karukkai</option>
                  <option value="Karumbur">Karumbur</option>
                  <option value="Kattugudalur">Kattugudalur</option>
                  <option value="Kavanur">Kavanur</option>
                  <option value="Kayapakkam">Kayapakkam</option>
                  <option value="Kilakuppam">Kilakuppam</option>
                  <option value="Kilarungunam">Kilarungunam</option>
                  <option value="Kiliruppu">Kiliruppu</option>
                  <option value="Kilkangeyankuppam">Kilkangeyankuppam</option>
                  <option value="Kilkavarapattu">Kilkavarapattu</option>
                  <option value="Kilmambattu">Kilmambattu</option>
                  <option value="Kolapakkam">Kolapakkam</option>
                  <option value="Kongarayanur">Kongarayanur</option>
                  <option value="Korathi">Korathi</option>
                  <option value="Kottambakkam">Kottambakkam</option>
                  <option value="Kozhipakkam">Kozhipakkam</option>
                  <option value="Lakshminarayanapuram (CT)">
                    Lakshminarayanapuram (CT)
                  </option>
                  <option value="Maligamedu">Maligamedu</option>
                  <option value="Maligampattu">Maligampattu</option>
                  <option value="Manamthavizhnthaputhur">
                    Manamthavizhnthaputhur
                  </option>
                  <option value="Manappakkam">Manappakkam</option>
                  <option value="Marungur">Marungur</option>
                  <option value="Melarungunam">Melarungunam</option>
                  <option value="Meliruppu">Meliruppu</option>
                  <option value="Melkangeyankuppam">Melkangeyankuppam</option>
                  <option value="Melkavarapattu">Melkavarapattu</option>
                  <option value="Melkumaramangalam (South)">
                    Melkumaramangalam (South)
                  </option>
                  <option value="Melmambattu">Melmambattu</option>
                  <option value="Nadukuppam">Nadukuppam</option>
                  <option value="Natham">Natham</option>
                  <option value="Oraiyur">Oraiyur</option>
                  <option value="Pagandai">Pagandai</option>
                  <option value="Paithambadi">Paithambadi</option>
                  <option value="Palappattu">Palappattu</option>
                  <option value="Pallavarayanatham">Pallavarayanatham</option>
                  <option value="Palur">Palur</option>
                  <option value="Panapakkam">Panapakkam</option>
                  <option value="Pandarakkottai">Pandarakkottai</option>
                  <option value="Panikkankuppam">Panikkankuppam</option>
                  <option value="Perperiyankuppam">Perperiyankuppam</option>
                  <option value="Perumalnaickenpalayam">
                    Perumalnaickenpalayam
                  </option>
                  <option value="Poondi">Poondi</option>
                  <option value="Poongunam">Poongunam</option>
                  <option value="Pulavanur">Pulavanur</option>
                  <option value="Purangani">Purangani</option>
                  <option value="Rayarpalayam">Rayarpalayam</option>
                  <option value="Sanniyasipettai">Sanniyasipettai</option>
                  <option value="Sathippattu">Sathippattu</option>
                  <option value="Semakottai">Semakottai</option>
                  <option value="Semmedu">Semmedu</option>
                  <option value="Silambinathanpettai">
                    Silambinathanpettai
                  </option>
                  <option value="Sirugramam">Sirugramam</option>
                  <option value="Sirunangaivadi">Sirunangaivadi</option>
                  <option value="Siruvathur">Siruvathur</option>
                  <option value="Sorathur">Sorathur</option>
                  <option value="Sundaravandi">Sundaravandi</option>
                  <option value="Talambattu">Talambattu</option>
                  <option value="Thirasu">Thirasu</option>
                  <option value="Thiruthuraiyur">Thiruthuraiyur</option>
                  <option value="Thorapadi (TP)">Thorapadi (TP)</option>
                  <option value="Tiruvamur">Tiruvamur</option>
                  <option value="Ulundamabattu">Ulundamabattu</option>
                  <option value="Vallam">Vallam</option>
                  <option value="Varinjipakkam">Varinjipakkam</option>
                  <option value="Veerapperumanallur">Veerapperumanallur</option>
                  <option value="Vegakollai">Vegakollai</option>
                  <option value="Virasingankuppam">Virasingankuppam</option>
                  <option value="Visur">Visur</option>
                  <option value="Pondicherry">Pondicherry</option>
                  <option value="Ariyalur">Ariyalur</option>
                  <option value="Chengalpattu">Chengalpattu</option>
                  <option value="Chennai">Chennai</option>
                  <option value="Coimbatore">Coimbatore</option>
                  <option value="Dharmapuri">Dharmapuri</option>
                  <option value="Dindigul">Dindigul</option>
                  <option value="Erode">Erode</option>
                  <option value="Kallakurichi">Kallakurichi</option>
                  <option value="Kancheepuram">Kancheepuram</option>
                  <option value="Karur">Karur</option>
                  <option value="Krishnagiri">Krishnagiri</option>
                  <option value="Madurai">Madurai</option>
                  <option value="Mayiladuthurai">Mayiladuthurai</option>
                  <option value="Nagapattinam">Nagapattinam</option>
                  <option value="Kanniyakumari">Kanniyakumari</option>
                  <option value="Namakkal">Namakkal</option>
                  <option value="Perambalur">Perambalur</option>
                  <option value="Pudukottai">Pudukottai</option>
                  <option value="Ramanathapuram">Ramanathapuram</option>
                  <option value="Ranipet">Ranipet</option>
                  <option value="Salem">Salem</option>
                  <option value="Sivagangai">Sivagangai</option>
                  <option value="Tenkasi">Tenkasi</option>
                  <option value="Thanjavur">Thanjavur</option>
                  <option value="Theni">Theni</option>
                  <option value="Thiruvallur">Thiruvallur</option>
                  <option value="Thoothukudi">Thoothukudi</option>
                  <option value="Thiruvarur">Thiruvarur</option>
                  <option value="Trichirappalli">Trichirappalli</option>
                  <option value="Thirunelveli">Thirunelveli</option>
                  <option value="Tirupathur">Tirupathur</option>
                  <option value="Tiruppur">Tiruppur</option>
                  <option value="Tiruvannamalai">Tiruvannamalai</option>
                  <option value="The Nilgiris">The Nilgiris</option>
                  <option value="Vellore">Vellore</option>
                  <option value="Virudhunagar">Virudhunagar</option>
                </select>
              </div>
              <div class="input-field">
                <label>Date of Birth</label>
                <input
                  type="date"
                  placeholder="Enter birth date"
                  name="Date of Birth"
                  id="date-of-birth"
                  min="1000-01-01"
                  max="9999-12-31"
                />
              </div>
              <div class="input-field">
                <label>Gender</label>
                <select name="Gender" id="gender" required title="Gender">
                  <option disabled selected>Select Gender</option>
                  <option>Male</option>
                  <option>Female</option>
                  <option>TransGender</option>
                </select>
              </div>
              <div class="input-field">
                <label>Dispositioned By</label>
                <input
                  placeholder="Enter Staff Name"
                  name="Dispositioned By"
                  id="dispositionedBy"
                  title="Dispositioned By"
                  required
                  readonly
                />
              </div>
            </div>
          </div>
          <div class="details ID">
            <span class="title">Service Details</span>
            <div class="fields">
              <div class="input-field">
                <label>Service Category</label>
                <select
                  name="Category"
                  id="category-select"
                  required
                  title="Category"
                >
                  <option disabled selected>Select Service Category</option>
                  <option value="General Services">General Services</option>
                  <option value="E-Sevai">E-Sevai</option>
                  <option value="Job Application Support">
                    Job Application Support
                  </option>
                  <option value="Travel Services">Travel Services</option>
                </select>
              </div>

              <div class="input-field">
                <label>Service Department</label>
                <select
                  name="Department"
                  id="department-select"
                  required
                  title="Department"
                >
                  <option disabled selected>Select Service Department</option>
                </select>
              </div>
              <div class="input-field" id="service-container">
                <label>Service Operation</label>

                <select
                  name="Service Operation"
                  id="service-select"
                  title="Service Operation"
                >
                  <option disabled selected value="Select Service Name">
                    Select Service Name
                  </option>
                </select>

                <!-- This is the text input, initially hidden -->
                <input
                  type="text"
                  id="service-input"
                  name="Service Operation"
                  placeholder="Please specify your service"
                  style="display: none"
                />
              </div>
              <div class="input-field">
                <label>Lead Generated Source</label>
                <select
                  name="Lead Generated Source"
                  id="lead-source-select"
                  required
                  title="Lead Generated Source"
                >
                  <option disabled>Select Lead Generated Source Name</option>
                  <option value="AIMS" selected>AIMS</option>
                </select>
              </div>
              <div class="input-field">
                <label>Customer Source</label>
                <select
                  name="Customer Source"
                  id="customer-source-select"
                  required
                  title="Customer Source"
                >
                  <option disabled>Select Customer Source Name</option>
                  <option selected value="Walk-in">Walk-in</option>
                </select>
              </div>
              <div class="input-field">
                <label>Referrel Code</label>
                <select
                  name="Referral Code"
                  id="referral-code-select"
                  required
                  title="Referral Code"
                >
                  <option disabled id="default-option">
                    Select Referral Code
                  </option>
                  <option value="AIMS-2007" selected>AIMS-2007</option>
                  <option value="AIMS-2024">AIMS-2024</option>
                </select>
              </div>
            </div>
            <button type="button" class="nextBtn" onclick="">
              <span class="btnText">Payment Details</span>
              <i class="uil uil-navigator"></i>
            </button>
          </div>
        </div>
        <div class="form second">
          <div class="details address">
            <span class="title">Payment Details</span>
            <div class="fields">
              <div class="input-field">
                <label>Application Charge</label>
                <input
                  type="number"
                  placeholder="Enter Application Charge"
                  name="Application Charge"
                  id="application-charge"
                  value="0"
                  required
                />
              </div>
              <div class="input-field">
                <label>Service Charge</label>
                <input
                  type="number"
                  placeholder="Enter Service Charge"
                  name="Service Charge"
                  id="service-charge"
                  required
                />
              </div>
              <div class="input-field">
                <label>Total Amount</label>
                <input
                  type="number"
                  placeholder="Service + Application Charge"
                  name="Total Amount"
                  id="total-amount"
                  required
                  readonly
                />
              </div>

              <div class="input-field">
                <label>In-Hand Cash</label>
                <input
                  type="number"
                  placeholder="Cash Amount"
                  name="In-Hand Cash"
                  id="cash"
                  readonly
                  required
                />
              </div>

              <div class="input-field">
                <label>Online Transaction - UPI</label>
                <input
                  type="number"
                  placeholder="Cash Amount"
                  name="Online Transaction - UPI"
                  id="upi"
                  value="0"
                  required
                />
              </div>

              <div class="input-field">
                <label>Debited Transaction Bank</label>
                <select
                  name="Debited Transaction Mode"
                  id="debited-transaction-bank"
                  required
                  title="Debited Transaction Mode"
                >
                  <option disabled selected>Select Debited Bank</option>
                  <option value="No Debits">No Debits</option>
                  <option value="KVB">KVB</option>
                  <option value="HDFC">HDFC</option>
                  <option value="Refai Account">Refai Account</option>
                  <option value="Anees Account">Anees Account</option>
                  <option value="E-Sevai Wallet">E-Sevai Wallet</option>
                  <option value="Pan Card Wallet">Pan Card Wallet</option>
                </select>
              </div>

              <div class="input-field">
                <label>Pending Amount</label>
                <input
                  type="number"
                  placeholder="Balance Amount"
                  id="unsettled-amount"
                  name="Unsettled Amount"
                  readonly
                />
              </div>
            </div>
          </div>

          <div class="details family">
            <div class="fields"></div>
            <div class="buttons">
              <div class="refreshBtn" id="refreshBtn">
                <i class="uil uil-sync"></i>
                <!-- Using a "sync" icon for refresh -->
                <span class="btnText">Refresh</span>
              </div>
            </div>
            <div class="buttons">
              <div class="backBtn">
                <i class="uil uil-navigator"></i>
                <span class="btnText">Back</span>
              </div>
              <button
                class="submit"
                type="submit"
                onclick="fetchCustomerDataOnLoad()"
              >
                <span class="btnText">Submit</span>
                <i class="uil uil-navigator"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Popup Notification -->
    <div id="popup" class="popup"></div>

    <!-- Box to display data -->
    <div id="employee-box">
      <div id="employee-name">Employee</div>
      <div id="lead-count">Lead</div>
    </div>

    <button
      class="form-button"
      onclick="window.location.href='../../index.html'"
    >
      <img src="../images/logout-button.png" alt="Exit Icon" />
    </button>

    <script>
      const popup = document.getElementById("popup");
      popup.textContent = "Welcome " + sessionStorage.getItem("loggedInUser");
      popup.classList.add("show");

      // Hide the popup after 3 seconds
      setTimeout(() => {
        popup.classList.remove("show");
      }, 6000);
    </script>

    <script>
      window.onload = function () {
        // Retrieve the logged-in user's name from localStorage
        const loggedInUser = sessionStorage.getItem("loggedInUser");
        // Debugging: Log retrieved value from localStorage
        console.log("Retrieved from localStorage:", loggedInUser);
      };
    </script>

    <script>
      // Replace this with your actual Google Apps Script URL
      const SHEET_JSON_URL =
        "https://script.google.com/macros/s/AKfycbw4-05dStQez5_PFraHcB3Nfi0YBgdFwsXlpNJAsW-d3bnconcGGz2wsAjxDZi6UX7u/exec";

      // Store the fetched customer data globally
      let customerData = [];

      // Fetch customer data when the page is loaded
      async function fetchCustomerDataOnLoad() {
        fetchEmployeeData();
        // Retrieve the logged-in user's name from localStorage
        const loggedInUser = sessionStorage.getItem("loggedInUser");

        // Debugging: Log retrieved value from localStorage
        console.log("Retrieved from localStorage:", loggedInUser);

        // If the username exists in localStorage, set the dropdown selection
        if (loggedInUser) {
          document.getElementById("dispositionedBy").value = loggedInUser;
        }
        try {
          const response = await fetch(SHEET_JSON_URL);
          if (!response.ok) {
            console.error(
              "Failed to fetch data:",
              response.status,
              response.statusText
            );
            // alert("Failed to fetch customer data. Please try again.");
            return;
          }

          customerData = await response.json();
          console.log("Fetched customer data:", customerData);

          // Show popup when data is successfully fetched
          // showPopup("Customer data");

          // After data is loaded, check if mobile number has 10 digits
          checkMobileNumber(); // Call to check the mobile number length
        } catch (error) {
          console.error("Error fetching customer data:", error);
          // alert("Failed to fetch customer data. Please try again.");
        }
      }

      async function reFetchCustomerDataOnLoad() {
        try {
          fetchEmployeeData();
          const response = await fetch(SHEET_JSON_URL);
          if (!response.ok) {
            console.error(
              "Failed to fetch data:",
              response.status,
              response.statusText
            );
            // alert("Failed to fetch customer data. Please try again.");
            return;
          }

          customerData = await response.json();
          // console.log("Fetched customer data:", customerData);

          // Show popup when data is successfully fetched
          // showPopup("Customer data");

          // After data is loaded, check if mobile number has 10 digits
          // checkMobileNumber(); // Call to check the mobile number length
        } catch (error) {
          console.error("Error fetching customer data:", error);
          // alert("Failed to fetch customer data. Please try again.");
        }
      }

      async function fetchEmployeeData() {
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbySyvjAvV07sF33RA6VYEh_af_S8YjKKdBNilyWdgM3DYWd7HyhWpEwMP6Nid4hOxyc/exec"
        ); // Replace with your Web App URL
        const data = await response.json();
        console.log(data);

        // Example: Match loggedInUser
        const loggedInUser = sessionStorage.getItem("loggedInUser");
        const userData = data.find(
          (user) => user["Employees Name"] === loggedInUser
        );

        if (userData) {
          document.getElementById("employee-name").innerText =
            userData["Employees Name"];
          document.getElementById("lead-count").innerText =
            userData["Lead Count"];
        }
      }

      // Call the fetch function when the page is loaded
      window.onload = fetchCustomerDataOnLoad;
      setInterval(reFetchCustomerDataOnLoad, 1000);

      // Check if mobile number has 10 digits before fetching data
      function checkMobileNumber() {
        const mobileInput = document.getElementById("mobile-number");
        const mobileNumber = mobileInput.value.trim();

        // If 10 digits are entered, fetch corresponding customer data
        if (mobileNumber.length === 10) {
          fetchCorrespondingCustomerData(mobileNumber);
        }
        // If less than 10 digits, do nothing
      }

      // Fetch and populate customer data based on the mobile number
      function fetchCorrespondingCustomerData(mobileNumber) {
        // Check if the data is already downloaded
        if (customerData.length === 0) {
          // alert(
          //   "Customer data is not available. Please wait for the data to load."
          // );
          return;
        }

        // Ensure the mobile number is valid
        if (mobileNumber.length !== 10 || isNaN(mobileNumber)) {
          alert("Please enter a valid 10-digit mobile number.");
          return;
        }

        // Find the customer by mobile number from the fetched customerData
        const customer = customerData.find(
          (row) => row["Mobile Number"] === Number(mobileNumber)
        );

        if (customer) {
          showPopup("Existing Customer");
          // Populate the form fields with the customer data
          document.getElementById("customer-name").value =
            customer["Customer Name"] || "";
          document.getElementById("location").value =
            customer["Location"] || "";

          // Check if Date of Birth is available and format it if necessary
          if (customer["Date of Birth"]) {
            var dob = new Date(customer["Date of Birth"]);
            var formattedDOB = dob.toISOString().split("T")[0]; // Format to YYYY-MM-DD
            document.getElementById("date-of-birth").value = formattedDOB;
          } else {
            console.log("Date of Birth is not available.");
            document.getElementById("date-of-birth").value = ""; // Clear field if empty
          }

          document.getElementById("gender").value = customer["Gender"] || "";
          document.getElementById("unsettled-amount").value =
            customer["Unsettled Amount"] || "";
        } else {
          showPopup("New Customer");
          // alert("Customer not found.");
          // clearFormFields();
        }
      }

      // Clear form fields if customer not found or error occurs
      function clearFormFields() {
        document.getElementById("customer-name").value = "";
        document.getElementById("location").value = "";
        document.getElementById("date-of-birth").value = "";
        document.getElementById("gender").value = "";
        document.getElementById("unsettled-amount").value = "";
      }

      // Show popup notification
      function showPopup(message) {
        const popup = document.getElementById("popup");
        popup.textContent = message;
        popup.classList.add("show");

        // Hide the popup after 3 seconds
        setTimeout(() => {
          popup.classList.remove("show");
        }, 6000);
      }
    </script>

    <script src="../js/script.js"></script>

    <script>
      // JavaScript for handling the "Refresh" button click
      document
        .getElementById("refreshBtn")
        .addEventListener("click", function () {
          // Simulate refresh by resetting the form and re-enabling any disabled buttons
          const form = document.getElementById("form");
          form.reset(); // Clears all form fields
          const submitButton = form.querySelector('button[type="submit"]');
          submitButton.disabled = false; // Re-enable the submit button

          alert("Form has been reset.");
        });
    </script>

    <script>
      const totalAmountInput = document.getElementById("total-amount");
      const cashInput = document.getElementById("cash");
      const upiInput = document.getElementById("upi");

      // Copy total amount to cash on input
      totalAmountInput.addEventListener("input", function () {
        const totalAmount = parseFloat(totalAmountInput.value) || 0;
        cashInput.value = totalAmount;
      });

      // Update cash value when UPI value changes
      upiInput.addEventListener("input", function () {
        const totalAmount = parseFloat(totalAmountInput.value) || 0;
        const upiAmount = parseFloat(upiInput.value) || 0;
        cashInput.value = totalAmount - upiAmount;
      });
    </script>
  </body>
</html>
